---
title: "Adventures in Bayesian Structural Time Series"
subtitle: "Part 5: Analyzing SST Data With Regression"
author: "Andrew Bates, Josh Gloyd, Tyler Tucker"
urlcolor: blue
header-includes:
  - \usepackage{themes/beamerthemednd}
output: beamer_presentation
#theme: 'dnd'
#colortheme: 'dndcolors'
#fonttheme: 'dndfonts'
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(fig.align = 'center', out.width = '95%',
                      message = FALSE, cache = TRUE)
```


<!-- slide 3 -->


## Outline

- SST data with covariates
- Use `bsts` to
    - Fit structural model with regression
    - Regression posterior
    - Forecast
    - Custom regresson prior
    
<!-- slide 4-->

## SST Data

- Sea Surface Temperature near Gibraltar
- Aggregated monthly
- January 2004 to April 2018
- Covariates: depth at 10, 20, ..., 90 meters

<!-- slide 5 -->

## SST Data

```{r, echo = FALSE}
knitr::include_graphics('images/tempColorChart.png')
```


<!-- slide 6 -->

## SST Data

```{r, echo = FALSE}
library(readr)
library(bsts)

gib <- read_csv("data/gilbralter_time_series_r_2.csv", 
                col_types = cols(startDate = col_skip(),
                                 timeIdx = col_skip()))
names(gib) <- c('SST', '10m', '20m', '30m', '40m',
                '50m', '60m', '70m', '80m', '90m')
gib_train <- gib[1:146, ]
gib_test <- gib[147:158, ]

ts.plot(gib_train$SST, main='SST of Gilbralter region',
     ylab='Temperature [C]', 
     ylim=c(15, 26))
```


<!-- slide 7 -->

## Setup

```{r, eval = FALSE}
library(readr)
library(bsts)

gib <- read_csv("data/gilbralter_time_series_r_2.csv", 
                col_types = cols(startDate = col_skip(), 
                                 timeIdx = col_skip()))
names(gib) <- c('SST', '10m', '20m', '30m', '40m',
                      '50m', '60m', '70m', '80m', '90m')
gib_train <- gib[1:146, ]
gib_test <- gib[147:158, ]
```


## SST Data

```{r}
head(gib_test[, 1:8])
```


<!-- slide 8 -->

## Model Fitting

```{r}
ss <- AddLocalLinearTrend(list(), gib$SST)
ss <- AddSeasonal(ss, gib$SST, nseasons = 12)
model1 <- bsts(SST ~., state.specification = ss,
               data = gib_train, niter = 1000, ping = 0)
```


<!-- slide 9 -->

## Model Plotting

```{r}
plot(model1, 'components')
```


<!-- slide 10 -->

## Model Plotting

```{r}
plot(model1, 'coefficients')
```




<!-- slide 11-->

## Forecasting


```{r}
model1_pred <- predict(model1, newdata = gib_test[, -1],
                       horizon = 12)
plot(model1_pred, plot.original = 36)
points(147:158, gib_test$SST, col = 'red')
```


<!-- slide 12 -->

## Custom Regression Prior

```{r}
model2 <- bsts(SST ~., state.specification = ss,
               data = gib_train, niter = 1000, ping = 0,
               expected.model.size = 2)
```


<!-- slide 13 -->

## Custom Regression Prior

```{r}
plot(model2, 'coefficients')
```


<!-- slide 14 -->

## Custom Regression Prior

```{r}
bp = c(.01,.5,.3,.3,.1,.1,.1,.1,.1,.1)
model3 <- bsts(SST ~., state.specification = ss,
               data = gib_train, niter = 1000, ping = 0,
               prior.inclusion.probabilities = bp)
```


<!-- slide 15 -->

## Custom Regression Prior

```{r}
plot(model3, 'coefficients')
```


<!-- slide 16 -->

## Forecasting

```{r}
model3_pred <- predict(model3, newdata = gib_test[,-1], 
                       horizon = 12)
plot(model3_pred, plot.original = 36)
points(147:158, gib_test$SST, col = 'red')
```



