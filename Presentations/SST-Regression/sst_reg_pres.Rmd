---
title: "Adventures in Bayesian Structural Time Series"
subtitle: "Part 4: Analyzing SST Data With Regression"
author: "Andrew Bates, Josh Gloyd, Tyler Tucker"
urlcolor: blue
header-includes:
  - \usepackage{themes/beamerthemednd}
output: beamer_presentation
#theme: 'dnd'
#colortheme: 'dndcolors'
#fonttheme: 'dndfonts'
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(fig.align = 'center', out.width = '95%',
                      message = FALSE, cache = TRUE)
```


<!-- slide 3 -->


## Outline

- SST data with covariates
- Use `bsts` to
    - Fit structural model with regression
    - Regression posterior
    - Forecast
    - Custom regresson prior
    
<!-- slide 4-->

## SST Data

- Sea Surface Temperature near Gibraltar
- Aggregated monthly
- January 2004 to November 2017
- Covariates: depth at 10, 20, ..., 90 meters

<!-- slide 5 -->

## SST Data

```{r, echo = FALSE}
knitr::include_graphics('images/tempColorChart.png')
```


<!-- slide 6 -->

## SST Data

```{r, echo = FALSE}
library(readr)
library(bsts)

gib <- read_csv("data/gilbralter_time_series_r.csv", 
                       col_types = cols(startDate = col_skip(), 
                                        timeIdx = col_skip()))
names(gib) <- c('SST', '10', '20', '30', '40',
                      '50', '60', '70', '80', '90')
gib <- zooreg(gib, start = c(2004, 1, 1), end = c(2017, 11, 29),
               frequency = 12)
plot(gib$SST, main='SST of Gilbralter region',
     xlab='date',
     ylab='Temperature [C]', 
     ylim=c(15, 26))
```


<!-- slide 7 -->

## Setup

```{r, eval = FALSE}
library(readr)
library(bsts)

gib <- read_csv("data/gilbralter_time_series_r.csv",
                col_types = cols(startDate = col_skip(),
                                 timeIdx = col_skip()))
names(gib) <- c('SST', '10', '20', '30', '40',
                      '50', '60', '70', '80', '90')
gib <- zooreg(gibraltar, start = c(2004, 1, 1),
              end = c(2017, 11, 29),
              frequency = 12)
```


<!-- slide 8 -->

## Model Fitting

```{r}
ss <- AddLocalLinearTrend(list(), gib$SST)
ss <- AddSeasonal(ss, gib$SST, nseasons = 12)
model1 <- bsts(SST ~., state.specification = ss,
               data = gib, niter = 1000, ping = 0)
```


<!-- slide 9 -->

## Model Plotting

```{r}
plot(model1, 'components')
```


<!-- slide 10 -->

## Model Plotting

```{r}
plot(model1, 'coefficients')
```




<!-- slide 11-->

## Forecasting


```{r, echo = FALSE}
newdata <- matrix(0, ncol = 9, nrow = 12)
newdata[1, ] <- colMeans(gib[, 2:10])
gib_sd <- apply(gib, 2, sd)
for(i in 2:12){
  for(j in 2:9)
  newdata[i, ] <- newdata[1, ] + 
      rnorm(1, sd = gib_sd[j])
}
```


```{r}
model1_pred <- predict(model1, newdata = newdata,
                       horizon = 12)
plot(model1_pred, plot.original = 36)
```


<!-- slide 12 -->

## Custom Regression Prior

```{r}
model2 <- bsts(SST ~., state.specification = ss,
               data = gib, niter = 1000, ping = 0,
               expected.model.size = 2)
```


<!-- slide 13 -->

## Custom Regression Prior

```{r}

plot(model2, 'coefficients')
```


<!-- slide 14 -->

## Custom Regression Prior

```{r}
model3 <- bsts(SST ~., state.specification = ss,
               data = gib, niter = 1000, ping = 0,
               prior.inclusion.probabilities = 
                 c(0.01, 0.5, 0.3, 0.3, 0.1, 0.1,
                   0.1, 0.1, 0.1, 0.1))
```


<!-- slide 15 -->

## Custom Regression Prior

```{r}
plot(model3, 'coefficients')
```





