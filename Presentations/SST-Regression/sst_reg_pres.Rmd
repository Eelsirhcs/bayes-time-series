---
title: "Adventures in Bayesian Structural Time Series"
subtitle: "Part 4: Analyzing SST Data With Regression"
author: "Andrew Bates, Josh Gloyd, Tyler Tucker"
urlcolor: blue
header-includes:
  - \usepackage{themes/beamerthemednd}
output: beamer_presentation
#theme: 'dnd'
#colortheme: 'dndcolors'
#fonttheme: 'dndfonts'
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(fig.align = 'center', out.width = '90%',
                      message = FALSE, cache = TRUE)
```


```{r, echo = FALSE}
knitr::include_graphics('images/tempColorChart.png')
```

## Outline

- SST data with covariates
- Use `bsts` to
    - Fit structural model with regression
    - Forecast
    - Custom regresson prior

## SST Data

- Sea Surface Temperature near Gibraltar
- Aggregated monthly
- January 2004 to November 2017
- Covariates: 10 meter thick water layers at 10, 20, ...,90  meters

## SST Data

```{r, echo = FALSE}
knitr::include_graphics('images/tempColorChart.png')
```

## SST Data

```{r, echo = FALSE}
library(readr)
library(bsts)

gib <- read_csv("data/gilbralter_ts_reg.csv", 
                       col_types = cols(startDate = col_skip(), 
                                        timeIdx = col_skip()))
names(gib) <- c('SST', '10', '20', '30', '40',
                      '50', '60', '70', '80', '90')
#gib <- zooreg(gib, start = c(2004, 1, 1), end = c(2017, 11, 29),
#               frequency = 12)
gib <- zooreg(gib)
nseasons = 11
ss <- list()
ss <- AddLocalLinearTrend(ss, gib$SST)
ss <- AddSeasonal(ss, gib$SST, nseasons=nseasons)
lls_model <- bsts(gib$SST,
               state.specification=ss,
               niter=1000, ping=0)
#plot(lls_model, 'components')
lls_model_pred <- predict(lls_model, newdata=newdata, horizon=12)
plot(lls_model_pred, plot.original = 36)
```

## Setup

```{r, eval = FALSE}
library(readr)
library(bsts)

gib <- read_csv("data/gilbralter_ts_reg.csv",
                col_types=cols(startDate=col_skip(),
                                 timeIdx=col_skip()))
names(gib) <- c('SST', '10', '20', '30', '40',
                      '50', '60', '70', '80', '90')
gib <- zooreg(gib)
```


## Model Fitting

### Local Trend With Seasonality and Regression

$\mu_t$: local linear trend 
$\tau_t$: seasonal component
$\beta_t^Tx_t$: regression component

\begin{align*}
&y_t = \mu_t + \tau_t + \beta_t^Tx_t  + \varepsilon_t &\varepsilon_t \sim N(0, \sigma^2_{\varepsilon})
\end{align*}

## SST Data

```{r, echo=FALSE}
print(gib[1:5, 1:5], digits=5)
```

## Forecasting Data
```{r, echo = TRUE}
newdata <- matrix(0, ncol=9, nrow=12)
newdata[1, ] <- colMeans(gib[, 2:10])
gib_sd <- apply(gib, 2, sd)
for(i in 2:12){
  for(j in 2:9){
  newdata[i, ] <- newdata[1, ] + rnorm(1, sd=gib_sd[j])}}
```

## Model 1
Local linear, seasonal, and one linear component
```{r}
nseasons = 11
ss <- list()
ss <- AddLocalLinearTrend(ss, gib$SST)
ss <- AddSeasonal(ss, gib$SST, nseasons=nseasons)
rlls_model <- bsts(SST ~., state.specification=ss,
               data=gib, niter=1000, ping=0,
               expected.model.size=1)
```


## Component Plotting
```{r}
plot(rlls_model, 'components')
```

## Covariate Significance
```{r}
plot(rlls_model, 'coefficients')
```

## Forcasting

```{r, fig.height=6}
rlls_model_pred <- predict(rlls_model,
                   newdata=newdata, horizon=12)
plot(rlls_model_pred, plot.original=36)
```

## Model 2
Local linear, and one linear component model
```{r}
ss <- list()
ss <- AddLocalLinearTrend(ss, gib$SST)
rll_model <- bsts(SST ~., state.specification = ss,
               data=gib, niter=1000, ping=0,
               expected.model.size=1)
```


## Component Plotting
```{r}
plot(rll_model, 'components')
```

## Covariate Significance
```{r}
plot(rll_model, 'coefficients')
```

## Forcasting

```{r fig.height=6}
rll_model_pred <- predict(rll_model,
                  newdata=newdata, horizon=12)
plot(rll_model_pred, plot.original=36)
```


## Model 3
Local linear, and five linear component model
```{r}
ss <- list()
ss <- AddLocalLinearTrend(ss, gib$SST)
r5ll_model <- bsts(SST ~., state.specification = ss,
               data=gib, niter=1000, ping=0,
               expected.model.size=5)
```

## Covariate Significance
```{r}
plot(r5ll_model, 'coefficients')
```

## Forcasting

```{r fig.height=6}
r5ll_model_pred <- predict(r5ll_model,
                  newdata=newdata, horizon=12)
plot(r5ll_model_pred, plot.original=36)
```

## Model Comparison

```{r, echo=FALSE, fig.height=6}
CompareBstsModels(lwd = 4,
                  model.list = list("No reg." = lls_model,
                       "Model 1" = rlls_model,
                       "Model 2" = rll_model,
                       "Model 3" = r5ll_model),
  colors = c("forestgreen", "firebrick", "blue4", "black"))
```



